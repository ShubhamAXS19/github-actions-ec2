name: Deploy to EC2

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
      
    - name: Start Deployment
      run: |
        echo "ğŸš€ Starting deployment at $(date)"
        echo "Branch: ${{ github.ref }}"
        echo "Commit: ${{ github.sha }}"
    
    - name: Configure SSH
      run: |
        echo "ğŸ”‘ Setting up SSH configuration..."
        mkdir -p ~/.ssh/
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/private_key.pem
        chmod 600 ~/.ssh/private_key.pem
        ssh-keyscan -H 65.0.31.64 >> ~/.ssh/known_hosts
        echo "âœ… SSH configured successfully"
    
    - name: Deploy to EC2
      run: |
        echo "ğŸ“¦ Starting deployment to EC2..."
        
        # Create a deployment log with timestamp
        DEPLOY_TIME=$(date '+%Y-%m-%d_%H-%M-%S')
        
        ssh -i ~/.ssh/private_key.pem ubuntu@65.0.31.64 "
          echo 'ğŸ“ Creating deployment directories...'
          mkdir -p ~/app
          mkdir -p ~/app/logs
          
          # Create detailed deployment log
          echo '=== Deployment Log ===' > ~/app/logs/deploy_${DEPLOY_TIME}.log
          echo 'Deployment Time: $(date)' >> ~/app/logs/deploy_${DEPLOY_TIME}.log
          echo 'Server Hostname: $(hostname)' >> ~/app/logs/deploy_${DEPLOY_TIME}.log
          echo 'Disk Space:' >> ~/app/logs/deploy_${DEPLOY_TIME}.log
          df -h >> ~/app/logs/deploy_${DEPLOY_TIME}.log
          echo 'Memory Usage:' >> ~/app/logs/deploy_${DEPLOY_TIME}.log
          free -m >> ~/app/logs/deploy_${DEPLOY_TIME}.log
          echo 'Running Processes:' >> ~/app/logs/deploy_${DEPLOY_TIME}.log
          ps aux | head -n 5 >> ~/app/logs/deploy_${DEPLOY_TIME}.log
          
          # Create a status file for quick check
          echo '{
            \"last_deployment\": \"'$(date)'\",
            \"status\": \"success\",
            \"commit_sha\": \"${{ github.sha }}\",
            \"branch\": \"${{ github.ref }}\"
          }' > ~/app/deploy-status.json
          
          # Create a simple HTML status page
          echo '<!DOCTYPE html>
          <html>
            <head>
              <title>Deployment Status</title>
              <style>
                body { font-family: Arial, sans-serif; margin: 40px; }
                .status { padding: 20px; border-radius: 5px; }
                .success { background: #e6ffe6; border: 1px solid #00cc00; }
              </style>
            </head>
            <body>
              <h1>Deployment Status</h1>
              <div class=\"status success\">
                <h2>âœ… Latest Deployment</h2>
                <p><strong>Time:</strong> '$(date)'</p>
                <p><strong>Status:</strong> Success</p>
                <p><strong>Commit:</strong> ${{ github.sha }}</p>
              </div>
            </body>
          </html>' > ~/app/status.html
          
          # Keep only last 5 log files (cleanup old logs)
          cd ~/app/logs && ls -t | tail -n +6 | xargs -I {} rm -- {}
          
          # Print latest deployment info
          echo 'âœ… Deployment completed successfully!'
          echo 'Latest deployment log:'
          cat ~/app/logs/deploy_${DEPLOY_TIME}.log
        "
        
        echo "âœ… Deployment completed successfully!"

    - name: Verify Deployment
      run: |
        echo "ğŸ” Verifying deployment..."
        ssh -i ~/.ssh/private_key.pem ubuntu@65.0.31.64 "
          if [ -f ~/app/deploy-status.json ]; then
            echo 'ğŸ“Š Deployment Status:'
            cat ~/app/deploy-status.json
            echo 'ğŸ“ Directory Structure:'
            ls -la ~/app
            echo 'ğŸ“ Latest Logs:'
            ls -la ~/app/logs
          else
            echo 'âŒ Deployment verification failed!'
            exit 1
          fi
        "

    - name: Deployment Summary
      if: always()
      run: |
        echo "===== Deployment Summary ====="
        echo "ğŸ•’ Time: $(date)"
        echo "ğŸ“ Branch: ${{ github.ref }}"
        echo "ğŸ” Commit: ${{ github.sha }}"
        echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
        if [ $? -eq 0 ]; then
          echo "âœ… Status: Success"
        else
          echo "âŒ Status: Failed"
        fi
        echo "==========================="